<!DOCTYPE html>
<html>
<!--  -->
<!--  -->
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="bootstrap.min.css">
</head>
<!--  -->
<!--  -->
<body>
	<div class="jumbotron text-center">
		<h1>Welcome to JSql drive</h1>
		<p>Fast relaiable Data-transmission using JS & NoSql database with localstorage  </p> 
	</div>

	
	<div class="container">
		<div class="row">
			<div class="col-sm-6">
				<h1>NewEntry</h1>
				First name:<br>
				<input type="text" id ="first" name="firstname"><br>
				Email:<br>
				<input type="text" id ="email" name="email"><br><br>
				<input type="submit" value="Submit1" onclick="updateDB('newU','LocalDBtable')">
				<input type="submit" value="Submit2" onclick="updateDB('newU2','LocalDBtable2')">
			</div>
			<div class="col-sm-6">
				<h1>Update</h1>
				First name:<br>
				<input type="text" id ="first" name="firstname">
				<br>
				Email:<br>
				<input type="text" id ="email" name="email">
				<br><br>
				<input type="submit" value="Submit1" onclick="updateDB('newU','LocalDBtable')">
				<!-- <input type="submit" value="Submit2" onclick="updateDB('newU2','LocalDBtable2')"> -->
			</div>
		</div>
	</div>
	<br><br>
	<div class="container">
	<div class="row">
		<div class="col-sm-6">
			<p>ServerDB at the START</p>
		</div>
		<div class="col-sm-6">
			<input type="button" value="LocalDB1" onclick="viewDB('newU', 'LocalDBtable')">
			<input type="button" value="LocalDB2" onclick="viewDB('newU2', 'LocalDBtable2')">
		</div>
	</div>
	<div class="row">
		<!-- <p>After Reload</p> -->
		<div class="col-sm-6">
		<p>server table for newU</p>
		<table class="table table-striped" id="demo1"></table>
		<p>server table for newU2</p>
		<table class="table table-striped" id="demo2"></table>
		</div>

		<div class="col-sm-6">
		<p>local table for newU</p>
		<table class="table table-striped" id="LocalDBtable"></table>
		<p>local table for newU2</p>
		<table class="table table-striped" id="LocalDBtable2"></table>
		</div>
	</div>
	<br><br>
	<div class="row">
		<div class="col-sm-6">
			<button onclick="postDB('star', 'newU', 'post')">Post1</button><br>
			<!-- <button onclick="postDB('star2', 'newU2', 'post2')">Post2</button><br> -->
		</div>
		<div class="col-sm-6">
			<p>post response from server names(table1)</p>
			<p id="post"></p>
			<p>post response from server names2(table2)</p>
			<p id="post2"></p>
		</div>
	</div>
		<table class="table table-striped" id="post_demo"></table>
	</div>
	</div>


	<div id="demo"></div>
	<div id="demop"></div>
	<p id="msg"></p>

 <script type="text/javascript" src="LocalStorageDB.js"></script>
 <script type="text/javascript">

	//This is where we should GET the data from the server
	var DB = new LocalStorageDB('my_first_database');
	// DB.DROP( 'temp4');
	// DB.DROP( 'temp3')
	// DB.DROP( 'temp2')
	// DB.DROP( 'temp1')
	// DB.DROP( 'temp')
	// DB.DROP( 'my_first_table');
	// DB.DROP( 'my_second_table');
	//DB.DROP('newU');
	var unsaved = false;
	var created = false;

	function getDB(siteName, localTableName, demoNum)
	{
		DB.DROP(localTableName);
		//GET JSON
		// var table=DB.SELECT( 'my_first_table' );
		created = true;

		var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 

		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				//document.getElementById("demo").innerHTML =
				//this.responseText;
				// console.log(this.responseText);
			var json_input=JSON.parse(this.responseText);
			CreateTableFromJSON(json_input,demoNum)
			//console.log(json_input);
			DB.CREATE( localTableName, {id: 0, name: "DARTH VADER", email: "force@dark.com"},function (a) {
			return {
			email: a.email,
			};});

			DB.INSERT_INTO(localTableName,json_input);
			//console.log(DB.SELECT(localTableName));
			}
		};

		//viewDB();

		xmlhttp.open("GET", "http://34.209.252.152/" + siteName);
		console.log("http://34.209.252.152/" + siteName);
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.send();

		//viewDB();
	}

	getDB("star", "newU", "demo1");
	//getDB("star2", "newU2", "demo2");

	function updateDB(localTableName, localTableNum)
	{
		var first_name=document.getElementById('first').value;
		var email=document.getElementById('email').value;
		DB.INSERT_INTO( localTableName, [{name:first_name,email:email}] );
		viewDB(localTableName, localTableNum);
		unsaved = true;
	}

	function viewDB(localTableName, localTableNum) {
		var table=DB.SELECT( localTableName );
		CreateTableFromJSON(table, localTableNum);
	}
	//'LocalDBtable'
	//viewDB();

	function CreateTableFromJSON(table, gid) {
		var myBooks = table;
		// EXTRACT VALUE FOR HTML HEADER. 
		// ('Book ID', 'Book Name', 'Category' and 'Price')
		var col = [];
		for (var i = 0; i < myBooks.length; i++) {
			for (var key in myBooks[i]) {
				if (col.indexOf(key) === -1) {
					col.push(key);
				}
			}
		}
		// CREATE DYNAMIC TABLE.
		var table = document.getElementById(gid);
		console.log("gid=" + gid);
		table.innerHTML = "";
		//var table = document.createElement("table")
		// CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

		var tr = table.insertRow(-1);                   // TABLE ROW.

		for (var i = 0; i < col.length; i++) {
			var th = document.createElement("th");      // TABLE HEADER.
			th.innerHTML = col[i];
			tr.appendChild(th);
		}

		// ADD JSON DATA TO THE TABLE AS ROWS.
		for (var i = 0; i < myBooks.length; i++) {

			tr = table.insertRow(-1);

			for (var j = 0; j < col.length; j++) {
				var tabCell = tr.insertCell(-1);
				tabCell.innerHTML = myBooks[i][col[j]];
			}
		}
	}

	function postDB(siteName,localTableName,postID)
	{

		// var table=DB.SELECT( 'my_first_table' );

		var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 

		xmlhttp.onreadystatechange = function() {
	
			if (this.readyState == 4 && this.status == 200) {
				document.getElementById(postID).innerHTML = "After Post";
				//this.responseText;
				var Jinput = JSON.parse(this.responseText);
				var datastrip = Jinput.result;
				//console.log("enter is fyn")
				CreateTableFromJSON(datastrip,'post_demo');
				//console.log("Exit is also is fyn")

			}
		};


		xmlhttp.open("POST", "http://34.209.252.152/" + siteName);
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		//console.log(DB.SELECT('newU'));
		xmlhttp.send(JSON.stringify(DB.SELECT(localTableName)));
		//DB.DROP('newU');
	}
	// window.alert = function(msg){
	//     postDB();
	// }

   
	// window.onunload = confirmExit;
	// function confirmExit(){
	//     var r = confirm("Close?");
	//     if (r == true) {
	//         postDB();
	//         alert("Bye")
	//     }else{
	//         document.getElementById("msg").innerHTML = "Nice Choice!"
	//     }
	//     //return false;
	// }

	function unloadPage(){ 
		if (created) {
			postDB('star', 'newU', 'post');
		}
		//postDB('star2', 'newU2', 'post2');
	    if(unsaved){
	        return "You have unsaved changes on this page. Do you want to leave this page and discard your changes or stay on this page?";
	    }
	}

	//window.onbeforeunload = unloadPage();
	//window.onbeforeunload = unloadPage('star2', 'newU2', 'post2');

	//This is where we should POST the data to the server
</script>


</body>
</html>
