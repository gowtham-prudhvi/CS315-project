<!DOCTYPE html>
<html>
<!--  -->
<!--  -->
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="bootstrap.min.css">
</head>
<!--  -->
<!--  -->
<body>
	<div class="jumbotron text-center">
		<h1>Welcome to JSql drive</h1>
		<p>Fast relaiable Data-transmission using JS & NoSql database with localstorage  </p> 
	</div>

	
	<div class="container">
		<div class="row">
			<div class="col-sm-6">
				<h1>NewEntry</h1>
				First name:<br>
				<input type="text" id ="first" name="firstname"><br>
				Email:<br>
				<input type="text" id ="email" name="email"><br><br>
				<input type="submit" value="Submit" onclick="updateDB()">
			</div>
			<div class="col-sm-6">
				<h1>Update</h1>
				First name:<br>
				<input type="text" id ="first" name="firstname">
				<br>
				Last name:<br>
				<input type="text" id ="email" name="email">
				<br><br>
				<input type="submit" value="Submit" onclick="updateDB()">
			</div>
		</div>
	</div>
	<br><br>
	<div class="container">
	<div class="row">
		<div class="col-sm-4">
		<input type="button" value="View ServerDB" onclick="viewDB()">
		</div>
	</div>
	<!-- <div class="row"> -->
		<table class="table table-striped" id="ServerDBtable"></table>
		<!-- </div> -->
	</div>


<div id="demo"></div>

<button onclick="postDB()"></button>
<!-- <p>If you click the "Submit" button, the form-data will be sent to a page called "/action_page.php".</p>
 -->
<p id="msg"></p>

 <script type="text/javascript" src="LocalStorageDB.js"></script>
 <script type="text/javascript">

	//This is where we should GET the data from the server
	var DB = new LocalStorageDB('my_first_database');
	// DB.DROP( 'temp4');
	// DB.DROP( 'temp3')
	// DB.DROP( 'temp2')
	// DB.DROP( 'temp1')
	// DB.DROP( 'temp')
	// DB.DROP( 'my_first_table');
	// DB.DROP( 'my_second_table');
	DB.DROP('users');

	function getDB()
	{
		//GET JSON
		// var table=DB.SELECT( 'my_first_table' );

		var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 

		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				document.getElementById("demo").innerHTML =
				this.responseText;
				// console.log(this.responseText);
			var json_input=JSON.parse(this.responseText);
			console.log(json_input);
			DB.CREATE( 'users', {id: 0, name: "DARTH VADER", email: "force@dark.com"},function (a) {
			return {
			email: a.email,
			};});

			DB.INSERT_INTO('users',json_input);
			console.log(DB.SELECT('users'));
			}
		};


		xmlhttp.open("GET", "http://34.209.252.152/star");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.send();
	}

	// DB.INSERT_INTO( 'temp4', [{foo2:'bar1'},{test2:'bat'}] );
  //   DB.INSERT_INTO( 'temp4', [{foo2:'bar1'},{test2:'bat'}] );
	getDB();

	// DB.CREATE( 'my_first_table', { id: 0, foo: 'bar', test: 'ing' } );
	// DB.INSERT_INTO( 'my_first_table', [{test:'ed'},{foo:'bat'}] );
	// console.log(DB.SELECT( 'my_first_table' ));
	 // DB.CREATE( 'my_second_table', { id: 0, foo2: 'bar', test2: 'ing' } );
	// DB.INSERT_INTO( 'my_second_table', [{test:'ed'},{foo:'bat'}] );
	// console.log(DB.SELECT( 'my_second_table' ));
	// console.log(DB.JOIN(DB.SELECT( 'my_first_table' ),DB.SELECT( 'my_second_table' ),"id","id",function (a, b) {
  //   return {
  //       id: a.id,
  //       foo2: b.foo2,
  //       test2: b.test2
  //   };}));

	function updateDB()
	{
		var first_name=document.getElementById('first').value;
		var email=document.getElementById('email').value;
		DB.INSERT_INTO( 'users', [{name:first_name,email:email}] );
	}
	function viewDB() {
		var table=DB.SELECT( 'users' );
		CreateTableFromJSON(table);
	}
	function CreateTableFromJSON(table) {
		var myBooks = table;

		// EXTRACT VALUE FOR HTML HEADER. 
		// ('Book ID', 'Book Name', 'Category' and 'Price')
		var col = [];
		for (var i = 0; i < myBooks.length; i++) {
			for (var key in myBooks[i]) {
				if (col.indexOf(key) === -1) {
					col.push(key);
				}
			}
		}

		// CREATE DYNAMIC TABLE.
		var table = document.getElementById("ServerDBtable");
		table.innerHTML = "";
		//var table = document.createElement("table")
		// CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

		var tr = table.insertRow(-1);                   // TABLE ROW.

		for (var i = 0; i < col.length; i++) {
			var th = document.createElement("th");      // TABLE HEADER.
			th.innerHTML = col[i];
			tr.appendChild(th);
		}

		// ADD JSON DATA TO THE TABLE AS ROWS.
		for (var i = 0; i < myBooks.length; i++) {

			tr = table.insertRow(-1);

			for (var j = 0; j < col.length; j++) {
				var tabCell = tr.insertCell(-1);
				tabCell.innerHTML = myBooks[i][col[j]];
			}
		}

		// FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
		//var divContainer = document.getElementById("ServerDBtable");
		//divContainer.innerHTML = "";
		//divContainer.appendChild(table);
	}

	// window.alert = function(msg){
	//     postDB();
	// }

   
	// window.onunload = confirmExit;
	// function confirmExit(){
	//     var r = confirm("Close?");
	//     if (r == true) {
	//         postDB();
	//         alert("Bye")
	//     }else{
	//         document.getElementById("msg").innerHTML = "Nice Choice!"
	//     }
	//     //return false;
	// }

	//This is where we should POST the data to the server
	function postDB()
	{

		// var table=DB.SELECT( 'my_first_table' );

		var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 

		xmlhttp.onreadystatechange = function() {
	
			if (this.readyState == 4 && this.status == 200) {
				document.getElementById("demo").innerHTML =
				this.responseText;
			}
		};


		xmlhttp.open("POST", "http://34.209.252.152/star");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		console.log(DB.SELECT('users'))
		xmlhttp.send(JSON.stringify(DB.SELECT('users')));
		//DB.DROP('users');


	}
	// function cons(){
	//     console.log("hii");
	// }

	// function confirmExit(){
	//     //return postDB();
	//     return cons();
	//     //alert("Bye");
	//     //return "Do you?";
	// }

	// window.onbeforeunload = confirmExit;
	// // postDB();

	// setTimeout(function(){
	//     postDB();
	//     self.close();
	// },2000);

	// $(window).bind('beforeunload', function(e){
	//     if(out)
	//         {
	//             postDB();
	//             for (var i=0;i<10000000000000000000000;i++){
	//                 // do something unnoticable but time consuming like writing a lot to console
	//                 console.log('buying some time to finish saving data'); 
	//             };
	//         }
	//     return "hello";
	// });

</script>


</body>
</html>
