<!DOCTYPE html>
<html>
<head>
	<style>
        table, th, td 
        {
            margin:10px 0;
            border:solid 1px #333;
            padding:2px 4px;
            font:15px Verdana;
        }
        th {
            font-weight:bold;
        }
    </style>
</head>
<body>

<h1>Update</h1>
  First name:<br>
  <input type="text" id ="first" name="firstname">
  <br>
  Last name:<br>
  <input type="text" id ="email" name="email">
  <br><br>
  <input type="submit" value="Submit" onclick="updateDB()">


<h1>View</h1>
<input type="button" value="Submit" onclick="viewDB()">

<div id="showData"></div>

<div id="demo"></div>


<button onclick="postDB()"></button>
<!-- <p>If you click the "Submit" button, the form-data will be sent to a page called "/action_page.php".</p>
 -->


 <script type="text/javascript" src="LocalStorageDB.js"></script>
 <script type="text/javascript">

 	//This is where we should GET the data from the server
 	var DB = new LocalStorageDB('my_first_database');
    // DB.DROP( 'temp4');
    // DB.DROP( 'temp3')
    // DB.DROP( 'temp2')
    // DB.DROP( 'temp1')
    // DB.DROP( 'temp')
    // DB.DROP( 'my_first_table');
    // DB.DROP( 'my_second_table');
    DB.DROP('users');

 	function getDB()
 	{
 		//GET JSON
        // var table=DB.SELECT( 'my_first_table' );

        var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 

        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("demo").innerHTML =
                this.responseText;
                // console.log(this.responseText);
            var json_input=JSON.parse(this.responseText);
            console.log(json_input);
            DB.CREATE( 'users', {email: "force@dark.com", id: 0, name: "DARTH VADER"},function (a) {
            return {
            email: a.email,
            };});

            DB.INSERT_INTO('users',json_input);
            console.log(DB.SELECT('users'));
            }
        };


        xmlhttp.open("GET", "http://34.209.252.152/star");
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp.send();
    }

 	// DB.INSERT_INTO( 'temp4', [{foo2:'bar1'},{test2:'bat'}] );
  //   DB.INSERT_INTO( 'temp4', [{foo2:'bar1'},{test2:'bat'}] );
    getDB();

 	// DB.CREATE( 'my_first_table', { id: 0, foo: 'bar', test: 'ing' } );
 	// DB.INSERT_INTO( 'my_first_table', [{test:'ed'},{foo:'bat'}] );
 	// console.log(DB.SELECT( 'my_first_table' ));
 	 // DB.CREATE( 'my_second_table', { id: 0, foo2: 'bar', test2: 'ing' } );
 	// DB.INSERT_INTO( 'my_second_table', [{test:'ed'},{foo:'bat'}] );
 	// console.log(DB.SELECT( 'my_second_table' ));
 	// console.log(DB.JOIN(DB.SELECT( 'my_first_table' ),DB.SELECT( 'my_second_table' ),"id","id",function (a, b) {
  //   return {
  //       id: a.id,
  //       foo2: b.foo2,
  //       test2: b.test2
  //   };}));

 	function updateDB()
 	{
 		var first_name=document.getElementById('first').value;
 		var email=document.getElementById('email').value;
 		DB.INSERT_INTO( 'users', [{name:first_name,email:email}] );
 	}
 	function viewDB() {
 		var table=DB.SELECT( 'users' );
 		CreateTableFromJSON(table);
 	}
    function CreateTableFromJSON(table) {
        var myBooks = table;

        // EXTRACT VALUE FOR HTML HEADER. 
        // ('Book ID', 'Book Name', 'Category' and 'Price')
        var col = [];
        for (var i = 0; i < myBooks.length; i++) {
            for (var key in myBooks[i]) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }

        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");

        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < myBooks.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = myBooks[i][col[j]];
            }
        }

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("showData");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
    }

    window.onbeforeunload = confirmExit;
    function confirmExit(){

        alert("wait for a few seconds");
        postDB();
        return false;
}
    //This is where we should POST the data to the server
 	function postDB()
 	{

        // var table=DB.SELECT( 'my_first_table' );

        var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 

        xmlhttp.onreadystatechange = function() {
    
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("demo").innerHTML =
                this.responseText;
            }
        };


        xmlhttp.open("POST", "http://34.209.252.152/star");
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        console.log(DB.SELECT('users'))
        xmlhttp.send(JSON.stringify(DB.SELECT('users')));
        DB.DROP('users');


 	}

    // postDB();

</script>


</body>
</html>
